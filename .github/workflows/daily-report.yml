name: Daily Publish Report

on:
  # æ¯å¤© UTC 1:00 = åŒ—äº¬æ—¶é—´ 9:00
  schedule:
    - cron: '0 1 * * *'

  # å…è®¸æ‰‹åŠ¨è§¦å‘æµ‹è¯•
  workflow_dispatch:

jobs:
  report:
    runs-on: ubuntu-latest

    steps:
      - name: Get workflow runs from last 24 hours
        id: get_runs
        uses: actions/github-script@v7
        with:
          script: |
            const now = new Date();
            const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);

            // è·å– auto-publish workflow çš„è¿è¡Œè®°å½•
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'auto-publish.yml',
              created: `>=${yesterday.toISOString()}`,
              per_page: 20
            });

            let total = 0;
            let success = 0;
            let failure = 0;
            let details = [];

            for (const run of runs.data.workflow_runs) {
              total++;
              if (run.conclusion === 'success') {
                success++;
              } else if (run.conclusion === 'failure') {
                failure++;
              }

              // è½¬æ¢ä¸ºåŒ—äº¬æ—¶é—´
              const runTime = new Date(run.created_at);
              const bjTime = new Date(runTime.getTime() + 8 * 60 * 60 * 1000);
              const timeStr = bjTime.toISOString().replace('T', ' ').substring(0, 19);

              details.push({
                time: timeStr,
                status: run.conclusion || 'running',
                url: run.html_url
              });
            }

            // ç”ŸæˆæŠ¥å‘Šæ—¥æœŸ
            const reportDate = new Date(now.getTime() + 8 * 60 * 60 * 1000);
            const dateStr = reportDate.toISOString().substring(0, 10);

            // çŠ¶æ€è¯„ä¼°
            let statusEmoji = 'âœ…';
            let statusText = 'æ­£å¸¸';
            if (failure > 0) {
              statusEmoji = 'âš ï¸';
              statusText = 'æœ‰å¤±è´¥';
            }
            if (total === 0) {
              statusEmoji = 'â“';
              statusText = 'æ— è®°å½•';
            }

            // æ„å»ºé‚®ä»¶å†…å®¹
            let emailBody = `WordPress è‡ªåŠ¨å‘å¸ƒæ¯æ—¥æŠ¥å‘Š\n`;
            emailBody += `æ—¥æœŸ: ${dateStr}\n`;
            emailBody += `================================\n\n`;
            emailBody += `ğŸ“Š è¿‡å» 24 å°æ—¶ç»Ÿè®¡:\n`;
            emailBody += `   æ€»è¿è¡Œæ¬¡æ•°: ${total}\n`;
            emailBody += `   æˆåŠŸ: ${success} âœ“\n`;
            emailBody += `   å¤±è´¥: ${failure} âœ—\n`;
            emailBody += `   çŠ¶æ€: ${statusEmoji} ${statusText}\n\n`;
            emailBody += `ğŸ“‹ è¯¦ç»†è®°å½•:\n`;
            emailBody += `--------------------------------\n`;

            for (const d of details) {
              const icon = d.status === 'success' ? 'âœ“' : (d.status === 'failure' ? 'âœ—' : 'â‹¯');
              emailBody += `${d.time} | ${icon} ${d.status}\n`;
            }

            if (details.length === 0) {
              emailBody += `(æ— è¿è¡Œè®°å½•)\n`;
            }

            emailBody += `\n================================\n`;
            emailBody += `GitHub Actions: https://github.com/${context.repo.owner}/${context.repo.repo}/actions\n`;

            // è®¾ç½®è¾“å‡º
            core.setOutput('date', dateStr);
            core.setOutput('total', total);
            core.setOutput('success', success);
            core.setOutput('failure', failure);
            core.setOutput('status_emoji', statusEmoji);
            core.setOutput('status_text', statusText);
            core.setOutput('email_body', emailBody);

            return { total, success, failure, details };

      - name: Send email report
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.GMAIL_USERNAME }}
          password: ${{ secrets.GMAIL_APP_PASSWORD }}
          subject: "${{ steps.get_runs.outputs.status_emoji }} WordPresså‘å¸ƒæŠ¥å‘Š ${{ steps.get_runs.outputs.date }} - ${{ steps.get_runs.outputs.status_text }}"
          to: Joseph.siyi@gmail.com
          from: WordPress Auto Publisher <${{ secrets.GMAIL_USERNAME }}>
          body: ${{ steps.get_runs.outputs.email_body }}
